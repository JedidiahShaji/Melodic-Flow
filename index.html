<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-AR">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MelodicFlow: A Generative Music Box</title>
    
    <!-- 1. Load Tailwind CSS for premium styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Google Font (Inter) for a clean, modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- 3. Load Tone.js (the core audio library) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        /* Apply the Inter font as the default */
        body {
            font-family: 'Inter', sans-serif;
            /* Create a subtle gradient for a more premium feel */
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
        }

        /* Custom style for the pulsing visual */
        #visual-pulsar {
            width: 100px;
            height: 100px;
            background-color: #4f46e5; /* indigo-600 */
            border-radius: 50%;
            transition: all 0.05s linear;
        }

        /* * Custom Slider Styles for a "Premium" Feel 
         * We'll hide the default thumb and track, and create
         * our own using Tailwind classes.
        */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #334155; /* slate-700 */
            border-radius: 9999px;
            outline: none;
            cursor: pointer;
        }

        /* Webkit (Chrome, Safari) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #e2e8f0; /* slate-200 */
            border-radius: 50%;
            border: 2px solid #4f46e5; /* indigo-600 */
            transition: background 0.2s ease-in-out;
        }
        input[type=range]:hover::-webkit-slider-thumb {
            background: #fff;
        }

        /* Firefox */
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #e2e8f0; /* slate-200 */
            border-radius: 50%;
            border: 2px solid #4f46e5; /* indigo-600 */
            transition: background 0.2s ease-in-out;
        }
        input[type=range]:hover::-moz-range-thumb {
            background: #fff;
        }

    </style>
</head>
<body class="h-full flex items-center justify-center antialiased">

    <div class="text-center p-8 max-w-md w-full">
        
        <!-- App Title -->
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-3">
            MelodicFlow
        </h1>
        <p class="text-lg md:text-xl text-slate-300 mb-12">
            A Generative Music Box
        </p>

        <!-- Pulsing Visual -->
        <div class="flex justify-center mb-12">
            <div id="visual-pulsar" class="shadow-2xl shadow-indigo-600/50"></div>
        </div>

        <!-- Start/Stop Button -->
        <button id="startButton" class="w-48 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105 hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75" disabled>
            Loading Audio...
        </button>

        <!-- --- CONTROLS --- -->
        <div id="controls" class="mt-12 space-y-6">
            
            <!-- 1. Tempo Slider -->
            <div class="w-full">
                <label for="tempo" class="block text-sm font-medium text-slate-300 mb-2">Tempo</label>
                <input type="range" id="tempo" min="60" max="150" value="90" class="w-full">
                <span id="tempoValue" class="text-xs text-slate-400">90 bpm</span>
            </div>

            <!-- 2. Density Slider -->
            <div class="w-full">
                <label for="density" class="block text-sm font-medium text-slate-300 mb-2">Note Density</label>
                <input type="range" id="density" min="0.1" max="1" value="0.35" step="0.01" class="w-full">
                <span id="densityValue" class="text-xs text-slate-400">35%</span>
            </div>

            <!-- 3. Reverb Slider -->
            <div class="w-full">
                <label for="reverb" class="block text-sm font-medium text-slate-300 mb-2">Reverb (Mix)</label>
                <input type="range" id="reverb" min="0" max="1" value="0.3" step="0.01" class="w-full">
                <span id="reverbValue" class="text-xs text-slate-400">30%</span>
            </div>

            <!-- 4. NEW: Delay Slider -->
            <div class="w-full">
                <label for="delay" class="block text-sm font-medium text-slate-300 mb-2">Delay (Mix)</label>
                <input type="range" id="delay" min="0" max="1" value="0" step="0.01" class="w-full">
                <span id="delayValue" class="text-xs text-slate-400">0%</span>
            </div>
        </div>
        <!-- --- END CONTROLS --- -->

    </div>

    <script>
        // --- DOM Elements ---
        const startButton = document.getElementById('startButton');
        const pulsar = document.getElementById('visual-pulsar');
        // New Slider Elements
        const tempoSlider = document.getElementById('tempo');
        const tempoValue = document.getElementById('tempoValue');
        const densitySlider = document.getElementById('density');
        const densityValue = document.getElementById('densityValue');
        const reverbSlider = document.getElementById('reverb');
        const reverbValue = document.getElementById('reverbValue');
        // NEW: Delay slider elements
        const delaySlider = document.getElementById('delay');
        const delayValue = document.getElementById('delayValue');


        // --- Audio State ---
        let isPlaying = false;
        let isInitialized = false; // To track if Tone.start() has been called

        // --- Audio Setup ---

        // 1. Create the main instrument (a Frequency Modulation Synth)
        const synth = new Tone.FMSynth(); // We won't send toDestination yet

        // 1b. Create the Ambient Pad Synth
        const padSynth = new Tone.PolySynth(Tone.AMSynth, {
            "harmonicity": 1.2,
            "oscillator" : {
                "type" : "fatsawtooth"
            },
            "envelope" : {
                "attack" : 2.5, // Slow attack
                "decay" : 0.1,
                "sustain" : 1,
                "release" : 5 // Slow release
            },
        }); // <-- REMOVED .toDestination()
        padSynth.volume.value = -18; // Very quiet

        // 2. Add some effects for that "premium" sound
        // A gentle reverb gives it space.
        const reverb = new Tone.Reverb(1.5).toDestination(); // <-- This is our FINAL output
        // Set initial reverb mix (wet/dry). We'll control this with the slider.
        reverb.wet.value = 0.3; // Start at 30% wet

        // 2b. NEW: Add PingPongDelay
        // "4n" = quarter note delay. 0.2 feedback.
        const pingPongDelay = new Tone.PingPongDelay("4n", 0.2);
        // Set initial mix to 0 (off).
        pingPongDelay.wet.value = 0; 

        // 2c. Create an Analyser for the visual
        const analyser = new Tone.Analyser('waveform', 128);
        
        // --- Audio Routing (This is the important part) ---
        
        // 1. Main synth goes to the analyser first
        synth.connect(analyser);
        
        // 2. Analysed signal goes to the Reverb
        analyser.connect(reverb);
        
        // 3. Analysed signal ALSO goes to the Delay
        analyser.connect(pingPongDelay);

        // 4. The Delay's output ALSO goes to the Reverb
        // (This makes the echos sound "washed out" and spacious)
        pingPongDelay.connect(reverb);

        // 5. The Pad synth goes straight to the Reverb
        padSynth.connect(reverb);
        
        // (Now, all sound correctly goes through the Reverb as the final master)


        // 3. Define the "palette" of notes (C Major Pentatonic)
        // This is a "safe" scale where most notes sound good together,
        // perfect for a calming generative melody.
        const scale = [
            'C4', 'D4', 'E4', 'G4', 'A4',
            'C5', 'D5', 'E5', 'G5', 'A5'
        ];

        // 4. Generative Logic Parameters
        let density = 0.35; // (35% chance a note will play)

        // 5. Create a generative loop
        const generativeLoop = new Tone.Loop((time) => {
            // Decision 1: Play or Rest?
            // We check our "density" parameter.
            if (Math.random() < density) {
                
                // Decision 2: Which note to play?
                // Pick a random note from our scale.
                const note = scale[Math.floor(Math.random() * scale.length)];
                
                // Trigger the synth. '8n' duration gives it a nice, gentle feel.
                synth.triggerAttackRelease(note, '8n', time);
            }
        }, '16n'); // The interval of the loop

        // 5b. Create a loop for the ambient pad
        // We'll use a simple, pleasant chord progression
        const chords = [
            ['C3', 'E3', 'G3'], // C Major
            ['G3', 'B3', 'D4'], // G Major
            ['A3', 'C4', 'E4'], // A Minor
            ['F3', 'A3', 'C4']  // F Major
        ];
        let chordIndex = 0;

        const padLoop = new Tone.Loop((time) => {
            // Get the current chord
            const currentChord = chords[chordIndex];
            // Trigger it with a long duration ('2m' = 2 measures)
            padSynth.triggerAttackRelease(currentChord, '2m', time);
            
            // Move to the next chord
            chordIndex = (chordIndex + 1) % chords.length;
        }, '2m'); // This loop runs every 2 measures

        // 6. Set the master transport (BPM)
        Tone.Transport.bpm.value = 90; // A calm, slow tempo
        
        // Start the loop (it's tied to the Transport, so it won't
        // make sound until Tone.Transport.start() is called)
        generativeLoop.start(0);
        padLoop.start(0); // <-- Start the pad loop too

        
        // --- Visual Loop ---
        // Function to update visual based on analyser
        function drawLoop() {
            // Get the analyser's value (an array of numbers)
            const values = analyser.getValue();
            // We'll just take the first value and find its magnitude
            let sum = 0;
            if (values.length > 0) {
                // Let's average the first few values for a stable "pulse"
                for(let i = 0; i < 10; i++) {
                    sum += Math.abs(values[i] || 0); // (add || 0 for safety)
                }
                let avg = sum / 10;
                
                // Map the value to a scale transformation
                // The '1' is the base scale, and 'avg * 5' is the pulse amount.
                // We multiply by 5 just to make the effect more visible.
                const scale = 1 + avg * 5;
                
                // Apply the scale to the pulsar element
                pulsar.style.transform = `scale(${scale})`;
            }

            // Keep the loop running if we are playing
            if (isPlaying) {
                requestAnimationFrame(drawLoop);
            }
        }

        // --- Event Listeners ---

        // Slider Listeners
        tempoSlider.addEventListener('input', (e) => {
            const newTempo = e.target.value;
            Tone.Transport.bpm.value = newTempo;
            tempoValue.textContent = `${newTempo} bpm`;
        });

        densitySlider.addEventListener('input', (e) => {
            const newDensity = e.target.value;
            density = newDensity;
            densityValue.textContent = `${Math.floor(newDensity * 100)}%`;
        });

        reverbSlider.addEventListener('input', (e) => {
            const newReverb = e.target.value;
            reverb.wet.value = newReverb;
            reverbValue.textContent = `${Math.floor(newReverb * 100)}%`;
        });

        // NEW: Delay listener
        delaySlider.addEventListener('input', (e) => {
            const newDelay = e.target.value;
            pingPongDelay.wet.value = newDelay;
            delayValue.textContent = `${Math.floor(newDelay * 100)}%`;
        });


        // The browser requires user interaction to start audio.
        async function initializeAudio() {
            await Tone.start();
            console.log('AudioContext started and ready.');
            isInitialized = true;
        }
        
        // We can initialize asynchronously as soon as the page loads,
        // but the 'Start' button click will also force it.
        Tone.loaded().then(() => {
            // Once the library is loaded, just enable the button.
            // Don't try to start the audio context yet.
            // That MUST happen on the user's click.
            console.log('Tone.js library loaded.');
            startButton.disabled = false;
            startButton.textContent = 'Start';
        });

        // Main play/stop toggle
        startButton.addEventListener('click', async () => {
            // If audio isn't on, this click will be the first user gesture.
            // We must 'await' Tone.start() on the first click.
            if (!isInitialized) {
                await initializeAudio();
            }

            // Toggle play/stop
            if (!isPlaying) {
                // Start the transport
                Tone.Transport.start();
                startButton.textContent = 'Stop';
                isPlaying = true;
                // Start the visual draw loop
                requestAnimationFrame(drawLoop);
            } else {
                // Stop the transport
                Tone.Transport.stop();
                startButton.textContent = 'Start';
                isPlaying = false;
            }
        });

    </script>
</body>
</html>