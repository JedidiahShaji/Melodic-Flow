<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-AR">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MelodicFlow: A Generative Music Box</title>
    
    <!-- 1. Load Tailwind CSS for premium styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Google Font (Inter) for a clean, modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- 3. Load Tone.js (the core audio library) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        /* Apply the Inter font as the default */
        body {
            font-family: 'Inter', sans-serif;
            /* Create a subtle gradient for a more premium feel */
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
        }

        /* Custom style for the pulsing visual */
        #visual-pulsar {
            width: 100px;
            height: 100px;
            background-color: #4f46e5; /* indigo-600 */
            border-radius: 50%;
            transition: all 0.05s linear;
        }

        /* * Custom Slider Styles for a "Premium" Feel 
         * We'll hide the default thumb and track, and create
         * our own using Tailwind classes.
        */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #334155; /* slate-700 */
            border-radius: 9999px;
            outline: none;
            cursor: pointer;
        }

        /* Webkit (Chrome, Safari) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #e2e8f0; /* slate-200 */
            border-radius: 50%;
            border: 2px solid #4f46e5; /* indigo-600 */
            transition: background 0.2s ease-in-out;
        }
        input[type=range]:hover::-webkit-slider-thumb {
            background: #fff;
        }

        /* Firefox */
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #e2e8f0; /* slate-200 */
            border-radius: 50%;
            border: 2px solid #4f46e5; /* indigo-600 */
            transition: background 0.2s ease-in-out;
        }
        input[type=range]:hover::-moz-range-thumb {
            background: #fff;
        }

        /* NEW: Mood Button Styles */
        .mood-btn {
            padding: 8px 16px;
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            color: #94a3b8; /* slate-400 */
            background-color: transparent;
            border: 2px solid #334155; /* slate-700 */
            border-radius: 9999px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .mood-btn:hover {
            color: #e2e8f0; /* slate-200 */
            border-color: #4f46e5; /* indigo-600 */
        }
        .mood-active {
            color: #fff;
            background-color: #4f46e5; /* indigo-600 */
            border-color: #4f46e5; /* indigo-600 */
        }

    </style>
</head>
<body class="h-full flex items-center justify-center antialiased">

    <div class="text-center p-8 max-w-md w-full">
        
        <!-- App Title -->
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-3">
            MelodicFlow
        </h1>
        <p class="text-lg md:text-xl text-slate-300 mb-8">
            A Generative Music Box
        </p>

        <!-- NEW: Mood Switcher -->
        <div id="moodSwitcher" class="flex justify-center space-x-2 mb-10">
            <button class="mood-btn mood-active" data-mood="ambient">Ambient</button>
            <button class="mood-btn" data-mood="lofi">Lofi</button>
            <button class="mood-btn" data-mood="dance">Dance</button>
        </div>

        <!-- Pulsing Visual -->
        <div class="flex justify-center mb-10">
            <div id="visual-pulsar" class="shadow-2xl shadow-indigo-600/50"></div>
        </div>

        <!-- Start/Stop Button -->
        <button id="startButton" class="w-48 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105 hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 mb-10" disabled>
            Loading Audio...
        </button>

        <!-- --- CONTROLS --- -->
        <div id="controls" class="mt-10 space-y-6">
            
            <!-- 1. Tempo Slider -->
            <div class="w-full">
                <label for="tempo" class="block text-sm font-medium text-slate-300 mb-2">Tempo</label>
                <input type="range" id="tempo" min="60" max="150" value="90" class="w-full">
                <span id="tempoValue" class="text-xs text-slate-400">90 bpm</span>
            </div>

            <!-- 2. Density Slider -->
            <div class="w-full">
                <label for="density" class="block text-sm font-medium text-slate-300 mb-2">Note Density</label>
                <input type="range" id="density" min="0.1" max="1" value="0.35" step="0.01" class="w-full">
                <span id="densityValue" class="text-xs text-slate-400">35%</span>
            </div>

            <!-- 3. Reverb Slider -->
            <div class="w-full">
                <label for="reverb" class="block text-sm font-medium text-slate-300 mb-2">Reverb (Mix)</label>
                <input type="range" id="reverb" min="0" max="1" value="0.3" step="0.01" class="w-full">
                <span id="reverbValue" class="text-xs text-slate-400">30%</span>
            </div>

            <!-- 4. NEW: Delay Slider -->
            <div class="w-full">
                <label for="delay" class="block text-sm font-medium text-slate-300 mb-2">Delay (Mix)</label>
                <input type="range" id="delay" min="0" max="1" value="0" step="0.01" class="w-full">
                <span id="delayValue" class="text-xs text-slate-400">0%</span>
            </div>
        </div>
        <!-- --- END CONTROLS --- -->

    </div>

    <script>
        // --- DOM Elements ---
        const startButton = document.getElementById('startButton');
        const pulsar = document.getElementById('visual-pulsar');
        // New Slider Elements
        const tempoSlider = document.getElementById('tempo');
        const tempoValue = document.getElementById('tempoValue');
        const densitySlider = document.getElementById('density');
        const densityValue = document.getElementById('densityValue');
        const reverbSlider = document.getElementById('reverb');
        const reverbValue = document.getElementById('reverbValue');
        const delaySlider = document.getElementById('delay');
        const delayValue = document.getElementById('delayValue');
        // NEW: Mood switcher elements
        const moodSwitcher = document.getElementById('moodSwitcher');


        // --- Audio State ---
        let isPlaying = false;
        let isInitialized = false;
        let currentMood = 'ambient';

        // --- Audio Setup ---

        // 1. Create the main instrument (a Frequency Modulation Synth)
        const synth = new Tone.FMSynth({
            "harmonicity": 3,
            "modulationIndex": 10,
            "oscillator": { "type": "fatsine" },
            "envelope": { "attack": 0.01, "decay": 0.1, "sustain": 0.5, "release": 0.5 },
            "modulationEnvelope": { "attack": 0.01, "decay": 0.0, "sustain": 1, "release": 0.5 }
        });

        // 1b. Create the Ambient Pad Synth
        const padSynth = new Tone.PolySynth(Tone.AMSynth, {
            "harmonicity": 1.2,
            "oscillator" : { "type" : "fatsawtooth" },
            "envelope" : { "attack" : 2.5, "decay" : 0.1, "sustain" : 1, "release" : 5 },
        });
        padSynth.volume.value = -18; // Very quiet
        
        // --- Pad Synth Presets ---
        const padPresets = {
            ambient: {
                "harmonicity": 1.2,
                "oscillator" : { "type" : "fatsawtooth" },
                "envelope" : { "attack" : 2.5, "decay" : 0.1, "sustain" : 1, "release" : 5 },
            },
            lofi: {
                "harmonicity": 1,
                "oscillator": { "type": "fatsine" }, // More like a rhodes
                "envelope": { "attack": 0.1, "decay": 0.0, "sustain": 1, "release": 1.5 },
            },
            // NEW: Dance pad preset
            dance: {
                "harmonicity": 1,
                "oscillator": { "type": "sawtooth" }, // Brighter sound
                "envelope": { "attack": 0.01, "decay": 0.1, "sustain": 0.3, "release": 0.5 },
            }
        };

        // 1c. NEW: Kick Drum
        const kickSynth = new Tone.MembraneSynth({
            "pitchDecay": 0.05,
            "octaves": 10,
            "oscillator": { "type": "sine" },
            "envelope": { "attack": 0.001, "decay": 0.4, "sustain": 0.01, "release": 1.4 }
        });
        // By default, the kick is muted.
        kickSynth.volume.value = -Infinity;

        // 1d. NEW: Hi-Hat
        const hiHatSynth = new Tone.NoiseSynth({
            "noise": { "type": "white" },
            "envelope": { "attack": 0.001, "decay": 0.1, "sustain": 0, "release": 0.1 }
        });
        hiHatSynth.volume.value = -Infinity; // Muted by default

        // --- Hi-Hat Synth Presets ---
        const hiHatPresets = {
            lofi: {
                "noise": { "type": "pink" }, // Warmer/softer 'shaker' sound
                "envelope": { "attack": 0.01, "decay": 0.15, "sustain": 0 }
            },
            dance: {
                "noise": { "type": "white" }, // Brighter/tighter 'hat' sound
                "envelope": { "attack": 0.001, "decay": 0.05, "sustain": 0 }
            }
        };

        // 2. Add some effects for that "premium" sound
        const reverb = new Tone.Reverb(1.5).toDestination(); // <-- This is our FINAL output
        reverb.wet.value = 0.3;

        // 2b. Add PingPongDelay
        const pingPongDelay = new Tone.PingPongDelay("4n", 0.2);
        pingPongDelay.wet.value = 0; 

        // 2c. NEW: Add Lofi Effects (initially "off")
        const lofiFilter = new Tone.Filter(20000, 'lowpass'); // Set to 20000 (fully open)
        const lofiCrush = new Tone.BitCrusher(16); // Set to 16 bits (clean)

        // 2d. Create an Analyser for the visual
        const analyser = new Tone.Analyser('waveform', 128);
        
        // --- Audio Routing (This is the important part) ---
        
        // 1. Main synth goes to the analyser first
        synth.connect(analyser);
        
        // 2. Analysed signal goes to the Delay
        analyser.connect(pingPongDelay);
        
        // 3. The Delay's output AND the Pad's output go to the Lofi effects
        pingPongDelay.connect(lofiFilter);
        padSynth.connect(lofiFilter);
        
        // 4. Lofi filter goes to crusher
        lofiFilter.connect(lofiCrush);

        // 5. Crusher goes to the FINAL Reverb
        lofiCrush.connect(reverb);
        
        // 6. The kick drum goes straight to the Lofi effects (and then reverb)
        // This lets it get crunchy in Lofi mode too!
        kickSynth.connect(lofiFilter);

        // 7. The main synth (analysed) also goes to the Lofi effects
        // This bypasses the delay for the "dry" signal
        analyser.connect(lofiFilter);

        // 8. NEW: Hi-hat also goes to Lofi filter
        hiHatSynth.connect(lofiFilter);


        // 3. Define the "palette" of notes
        const scales = {
            ambient: [
                'C4', 'D4', 'E4', 'G4', 'A4',
                'C5', 'D5', 'E5', 'G5', 'A5'
            ],
            lofi: [
                'C4', 'Eb4', 'F4', 'G4', 'Bb4',
                'C5', 'Eb5', 'F5', 'G5', 'Bb5'
            ],
            // NEW: Dance scale
            dance: [
                'C4', 'D4', 'E4', 'G4', 'A4',
                'C5', 'D5', 'E5', 'G5', 'A5'
            ] // Same as ambient, but we'll use it differently
        };
        let activeScale = scales.ambient; // Start with ambient

        // 4. Generative Logic Parameters
        let density = 0.35; // (35% chance a note will play)

        // 5. Create a generative loop
        const generativeLoop = new Tone.Loop((time) => {
            // Decision 1: Play or Rest?
            // We check our "density" parameter.
            if (Math.random() < density) {
                
                // Decision 2: Which note to play?
                // Pick a random note from our *active* scale.
                const note = activeScale[Math.floor(Math.random() * activeScale.length)];
                
                // Trigger the synth. '8n' duration gives it a nice, gentle feel.
                synth.triggerAttackRelease(note, '8n', time);
            }
        }, '16n'); // The interval of the loop

        // 5b. Create a loop for the ambient pad
        const chords = {
            ambient: [
                ['C3', 'E3', 'G3'], // C Major
                ['G3', 'B3', 'D4'], // G Major
                ['A3', 'C4', 'E4'], // A Minor
                ['F3', 'A3', 'C4']  // F Major
            ],
            lofi: [
                ['C3', 'Eb3', 'G3', 'Bb3'], // Cm7
                ['F3', 'Ab3', 'C4', 'Eb4'], // Fm7
                ['Ab3', 'C4', 'Eb4', 'G4'], // Abmaj7
                ['G3', 'B3', 'D4', 'F4']  // G7
            ],
            // NEW: Dance chords (classic 1-5-6-4 progression)
            dance: [
                ['C3', 'E3', 'G3'], // C Major
                ['G3', 'B3', 'D4'], // G Major
                ['A3', 'C4', 'E4'], // A Minor
                ['F3', 'A3', 'C4']  // F Major
            ] // Same as ambient, but context will make it upbeat
        };
        let activeChords = chords.ambient;
        let chordIndex = 0;

        const padLoop = new Tone.Loop((time) => {
            // Get the current chord from the *active* set
            const currentChord = activeChords[chordIndex];
            // Trigger it with a long duration ('2m' = 2 measures)
            padSynth.triggerAttackRelease(currentChord, '2m', time);
            
            // Move to the next chord
            chordIndex = (chordIndex + 1) % activeChords.length;
        }, '2m'); // This loop runs every 2 measures

        // 5c. NEW: Create a loop for the kick drum
        const kickLoop = new Tone.Loop((time) => {
            // "4n" = quarter note (four-on-the-floor beat)
            kickSynth.triggerAttackRelease('C1', '8n', time);
        }, '4n');

        // 5d. NEW: Create a loop for the hi-hat
        const hiHatPatterns = {
            ambient: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], // Off
            lofi:    [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0], // Off-beat 'shaker' (on the '&')
            dance:   [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0]  // Off-beat 8th note
        };
        let hiHatPattern = hiHatPatterns.ambient;
        let hiHatStep = 0;

        const hiHatLoop = new Tone.Loop((time) => {
            let patternStep = hiHatPattern[hiHatStep];
            if (patternStep === 1) {
                // Use triggerAttack for a very short, percussive sound
                hiHatSynth.triggerAttack(time);
            }
            hiHatStep = (hiHatStep + 1) % hiHatPattern.length;
        }, '16n'); // This loop must run every 16th note to read the pattern


        // 6. Set the master transport (BPM)
        Tone.Transport.bpm.value = 90; // A calm, slow tempo
        
        // Start the loop (it's tied to the Transport, so it won't
        // make sound until Tone.Transport.start() is called)
        generativeLoop.start(0);
        padLoop.start(0);
        kickLoop.start(0); // <-- Start the kick loop (it's muted, so no sound yet)
        hiHatLoop.start(0); // <-- Start the hi-hat loop (also muted)

        
        // --- Visual Loop ---
        // Function to update visual based on analyser
        function drawLoop() {
            // Get the analyser's value (an array of numbers)
            const values = analyser.getValue();
            // We'll just take the first value and find its magnitude
            let sum = 0;
            if (values.length > 0) {
                // Let's average the first few values for a stable "pulse"
                for(let i = 0; i < 10; i++) {
                    sum += Math.abs(values[i] || 0); // (add || 0 for safety)
                }
                let avg = sum / 10;
                
                // Map the value to a scale transformation
                // The '1' is the base scale, and 'avg * 5' is the pulse amount.
                // We multiply by 5 just to make the effect more visible.
                const scale = 1 + avg * 5;
                
                // Apply the scale to the pulsar element
                pulsar.style.transform = `scale(${scale})`;
            }

            // Keep the loop running if we are playing
            if (isPlaying) {
                requestAnimationFrame(drawLoop);
            }
        }

        // --- Event Listeners ---

        // Slider Listeners
        tempoSlider.addEventListener('input', (e) => {
            const newTempo = e.target.value;
            Tone.Transport.bpm.value = newTempo;
            tempoValue.textContent = `${newTempo} bpm`;
        });

        densitySlider.addEventListener('input', (e) => {
            const newDensity = e.target.value;
            density = newDensity;
            densityValue.textContent = `${Math.floor(newDensity * 100)}%`;
        });

        reverbSlider.addEventListener('input', (e) => {
            const newReverb = e.target.value;
            reverb.wet.value = newReverb;
            reverbValue.textContent = `${Math.floor(newReverb * 100)}%`;
        });

        delaySlider.addEventListener('input', (e) => {
            const newDelay = e.target.value;
            pingPongDelay.wet.value = newDelay;
            delayValue.textContent = `${Math.floor(newDelay * 100)}%`;
        });

        // NEW: Mood Switcher Listener (using event delegation)
        moodSwitcher.addEventListener('click', (e) => {
            const button = e.target.closest('.mood-btn');
            if (!button) return; // Clicked in the gap

            const newMood = button.dataset.mood;
            if (newMood === currentMood) return; // Already on this mood
            
            setMood(newMood);
        });

        function setMood(newMood) {
            currentMood = newMood;

            // 1. Update Button UI
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('mood-active');
                if (btn.dataset.mood === newMood) {
                    btn.classList.add('mood-active');
                }
            });

            // 2. Update Audio Parameters
            if (newMood === 'ambient') {
                // Set notes and chords
                activeScale = scales.ambient;
                activeChords = chords.ambient;
                
                // Set pad synth preset
                padSynth.set(padPresets.ambient);
                
                // Set Lofi effects "off" (clean signal)
                lofiFilter.frequency.rampTo(20000, 0.5); // Open filter
                lofiCrush.bits.value = 16; // 16 bits (clean)
                
                // Mute kick
                kickSynth.volume.rampTo(-Infinity, 0.5);
                // Mute hi-hat
                hiHatSynth.volume.rampTo(-Infinity, 0.5);
                hiHatPattern = hiHatPatterns.ambient;

            } else if (newMood === 'lofi') {
                // Set notes and chords
                activeScale = scales.lofi;
                activeChords = chords.lofi;

                // Set pad synth preset
                padSynth.set(padPresets.lofi);

                // Set Lofi effects "on"
                lofiFilter.frequency.rampTo(1500, 0.5); // Muffled filter
                lofiCrush.bits.value = 8; // 8 bits (crunchy)
                
                // Mute kick
                kickSynth.volume.rampTo(-Infinity, 0.5);
                
                // UN-Mute hi-hat (lofi style)
                hiHatSynth.set(hiHatPresets.lofi);
                hiHatPattern = hiHatPatterns.lofi;
                hiHatSynth.volume.rampTo(-12, 0.5); // Quiet 'shaker' volume

            } else if (newMood === 'dance') {
                // Set notes and chords
                activeScale = scales.dance;
                activeChords = chords.dance;

                // Set pad synth preset
                padSynth.set(padPresets.dance);

                // Set Lofi effects "off"
                lofiFilter.frequency.rampTo(20000, 0.5);
                lofiCrush.bits.value = 16;
                
                // UN-Mute kick
                kickSynth.volume.rampTo(0, 0.1); // 0dB (full volume)

                // UN-Mute hi-hat (dance style)
                hiHatSynth.set(hiHatPresets.dance);
                hiHatPattern = hiHatPatterns.dance;
                hiHatSynth.volume.rampTo(-8, 0.1); // Louder 'hat' volume

                // Suggest a faster tempo (but don't force it)
                if (Tone.Transport.bpm.value < 100) {
                    tempoSlider.value = 110;
                    Tone.Transport.bpm.value = 110;
                    tempoValue.textContent = "110 bpm";
                }
            }
            
            // Reset chord index to avoid weird transitions
            chordIndex = 0;
            hiHatStep = 0; // Reset hi-hat pattern
        }


        // The browser requires user interaction to start audio.
        async function initializeAudio() {
            await Tone.start();
            console.log('AudioContext started and ready.');
            isInitialized = true;
        }
        
        // We can initialize asynchronously as soon as the page loads,
        // but the 'Start' button click will also force it.
        Tone.loaded().then(() => {
            // Once the library is loaded, just enable the button.
            // Don't try to start the audio context yet.
            // That MUST happen on the user's click.
            console.log('Tone.js library loaded.');
            startButton.disabled = false;
            startButton.textContent = 'Start';
        });

        // Main play/stop toggle
        startButton.addEventListener('click', async () => {
            // If audio isn't on, this click will be the first user gesture.
            // We must 'await' Tone.start() on the first click.
            if (!isInitialized) {
                await initializeAudio();
            }

            // Toggle play/stop
            if (!isPlaying) {
                // Start the transport
                Tone.Transport.start();
                startButton.textContent = 'Stop';
                isPlaying = true;
                // Start the visual draw loop
                requestAnimationFrame(drawLoop);
            } else {
                // Stop the transport
                Tone.Transport.stop();
                startButton.textContent = 'Start';
                isPlaying = false;
            }
        });

    </script>
</body>
</html>