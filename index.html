<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-AR">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MelodicFlow: A Generative Music Box</title>
    
    <!-- 1. Load Tailwind CSS for premium styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Google Font (Inter) for a clean, modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- 3. Load Tone.js (the core audio library) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        /* Apply the Inter font as the default */
        body {
            font-family: 'Inter', sans-serif;
            /* Create a subtle gradient for a more premium feel */
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
        }

        /* Custom style for the pulsing visual (we'll use this later) */
        #visual-pulsar {
            width: 100px;
            height: 100px;
            background-color: #4f46e5; /* indigo-600 */
            border-radius: 50%;
            transition: all 0.05s linear;
        }

        /* * Custom Slider Styles for a "Premium" Feel 
         * We'll hide the default thumb and track, and create
         * our own using Tailwind classes.
        */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #334155; /* slate-700 */
            border-radius: 9999px;
            outline: none;
            cursor: pointer;
        }

        /* Webkit (Chrome, Safari) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #e2e8f0; /* slate-200 */
            border-radius: 50%;
            border: 2px solid #4f46e5; /* indigo-600 */
            transition: background 0.2s ease-in-out;
        }
        input[type=range]:hover::-webkit-slider-thumb {
            background: #fff;
        }

        /* Firefox */
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #e2e8f0; /* slate-200 */
            border-radius: 50%;
            border: 2px solid #4f46e5; /* indigo-600 */
            transition: background 0.2s ease-in-out;
        }
        input[type=range]:hover::-moz-range-thumb {
            background: #fff;
        }

    </style>
</head>
<body class="h-full flex items-center justify-center antialiased">

    <div class="text-center p-8 max-w-md w-full">
        
        <!-- App Title -->
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-3">
            MelodicFlow
        </h1>
        <p class="text-lg md:text-xl text-slate-300 mb-12">
            A Generative Music Box
        </p>

        <!-- Pulsing Visual (Placeholder for now) -->
        <div class="flex justify-center mb-12">
            <div id="visual-pulsar" class="shadow-2xl shadow-indigo-600/50"></div>
        </div>

        <!-- Start/Stop Button -->
        <button id="startButton" class="w-48 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105 hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75" disabled>
            Loading Audio...
        </button>

        <!-- --- CONTROLS --- -->
        <div id="controls" class="mt-12 space-y-6">
            
            <!-- 1. Tempo Slider -->
            <div class="w-full">
                <label for="tempo" class="block text-sm font-medium text-slate-300 mb-2">Tempo</label>
                <input type="range" id="tempo" min="60" max="150" value="90" class="w-full">
                <span id="tempoValue" class="text-xs text-slate-400">90 bpm</span>
            </div>

            <!-- 2. Density Slider -->
            <div class="w-full">
                <label for="density" class="block text-sm font-medium text-slate-300 mb-2">Note Density</label>
                <input type="range" id="density" min="0.1" max="1" value="0.35" step="0.01" class="w-full">
                <span id="densityValue" class="text-xs text-slate-400">35%</span>
            </div>

            <!-- 3. Reverb Slider -->
            <div class="w-full">
                <label for="reverb" class="block text-sm font-medium text-slate-300 mb-2">Reverb (Mix)</label>
                <input type="range" id="reverb" min="0" max="1" value="0.3" step="0.01" class="w-full">
                <span id="reverbValue" class="text-xs text-slate-400">30%</span>
            </div>
        </div>
        <!-- --- END CONTROLS --- -->

    </div>

    <script>
        // --- DOM Elements ---
        const startButton = document.getElementById('startButton');
        const pulsar = document.getElementById('visual-pulsar');
        // New Slider Elements
        const tempoSlider = document.getElementById('tempo');
        const tempoValue = document.getElementById('tempoValue');
        const densitySlider = document.getElementById('density');
        const densityValue = document.getElementById('densityValue');
        const reverbSlider = document.getElementById('reverb');
        const reverbValue = document.getElementById('reverbValue');


        // --- Audio State ---
        let isPlaying = false;
        let isInitialized = false; // To track if Tone.start() has been called

        // --- Audio Setup ---

        // 1. Create the main instrument (a Frequency Modulation Synth)
        // We send it 'toDestination' so we can hear it.
        // *** FIX: Added synth definition ***
        const synth = new Tone.FMSynth().toDestination();

        // 2. Add some effects for that "premium" sound
        // A gentle reverb gives it space.
        const reverb = new Tone.Reverb(1.5).toDestination(); // 1.5-second decay
        synth.connect(reverb); // <-- This now works
        // Set initial reverb mix (wet/dry). We'll control this with the slider.
        reverb.wet.value = 0.3; // Start at 30% wet

        // 3. Define the "palette" of notes (C Major Pentatonic)
        // This is a "safe" scale where most notes sound good together,
        // perfect for a calming generative melody.
        const scale = [
            'C4', 'D4', 'E4', 'G4', 'A4',
            'C5', 'D5', 'E5', 'G5', 'A5'
        ];

        // 4. Generative Logic Parameters
        // We will hook these up to sliders later.
        let density = 0.35; // (35% chance a note will play)

        // 5. Create a generative loop
        // We replace Tone.Sequence with Tone.Loop.
        // This loop will run every 16th note ('16n').
        const generativeLoop = new Tone.Loop((time) => {
            // Decision 1: Play or Rest?
            // We check our "density" parameter.
            if (Math.random() < density) {
                
                // Decision 2: Which note to play?
                // Pick a random note from our scale.
                const note = scale[Math.floor(Math.random() * scale.length)];
                
                // Trigger the synth. '8n' duration gives it a nice, gentle feel.
                synth.triggerAttackRelease(note, '8n', time);
                
                // Trigger the visual pulse
                // (We'll make this more accurate with Tone.Analyser later)
                pulsar.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    pulsar.style.transform = 'scale(1)';
                }, 100); // Reset after 100ms
            }
        }, '16n'); // The interval of the loop

        // 6. Set the master transport (BPM)
        // This will be controlled by a slider later.
        Tone.Transport.bpm.value = 90; // A calm, slow tempo
        
        // Start the loop (it's tied to the Transport, so it won't
        // make sound until Tone.Transport.start() is called)
        generativeLoop.start(0);

        
        // --- Event Listeners ---

        // Slider Listeners
        tempoSlider.addEventListener('input', (e) => {
            const newTempo = e.target.value;
            Tone.Transport.bpm.value = newTempo;
            tempoValue.textContent = `${newTempo} bpm`;
        });

        densitySlider.addEventListener('input', (e) => {
            const newDensity = e.target.value;
            density = newDensity;
            densityValue.textContent = `${Math.floor(newDensity * 100)}%`;
        });

        reverbSlider.addEventListener('input', (e) => {
            const newReverb = e.target.value;
            reverb.wet.value = newReverb;
            reverbValue.textContent = `${Math.floor(newReverb * 100)}%`;
        });


        // The browser requires user interaction to start audio.
        // We'll use this function to initialize Tone.js on the first click.
        async function initializeAudio() {
            // This is deprecated but necessary for some browsers
            await Tone.start();
            console.log('AudioContext started and ready.');
            isInitialized = true;
            // No longer needed, as we enable on Tone.loaded()
            // startButton.disabled = false;
            // startButton.textContent = 'Start';
        }
        
        // We can initialize asynchronously as soon as the page loads,
        // but the 'Start' button click will also force it.
        // Let's try to load it gently first.
        Tone.loaded().then(() => {
            // Once the library is loaded, just enable the button.
            // Don't try to start the audio context yet.
            // That MUST happen on the user's click.
            console.log('Tone.js library loaded.');
            startButton.disabled = false;
            startButton.textContent = 'Start';
        });

        // Main play/stop toggle
        startButton.addEventListener('click', async () => { // <-- Add 'async'
            // If audio isn't on, this click will be the first user gesture.
            // We must 'await' Tone.start() on the first click.
            if (!isInitialized) {
                await Tone.start(); // <-- New, correct way
                console.log('AudioContext started and ready.');
                isInitialized = true;
            }

            // Toggle play/stop
            if (!isPlaying) {
                // Start the transport
                Tone.Transport.start();
                startButton.textContent = 'Stop';
                isPlaying = true;
            } else {
                // Stop the transport
                Tone.Transport.stop();
                startButton.textContent = 'Start';
                isPlaying = false;
            }
        });

    </script>
</body>
</html>